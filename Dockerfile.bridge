FROM node:18-alpine

ARG MONGODB_URL
ARG MONGODB_DBNAME
ARG DISCORD_CLIENT_ID
ARG DISCORD_DEV_GUILD_ID
ARG BRIDGE_HOST
ARG DISCORD_TOKEN
ARG BRIDGE_AUTH_TOKEN
ARG PORT
ARG BRIDGE_IDENTITY
ARG BRIDGE_PSK
ARG BRIDGE_TOTAL_MACHINES
ARG SHARD_PER_CLUSTER

ENV MONGODB_URL=${MONGODB_URL}
ENV MONGODB_DBNAME=${MONGODB_DBNAME}
ENV DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
ENV DISCORD_DEV_GUILD_ID=${DISCORD_DEV_GUILD_ID}
ENV BRIDGE_HOST=${BRIDGE_HOST}
ENV DISCORD_TOKEN=${DISCORD_TOKEN}
ENV BRIDGE_AUTH_TOKEN=${BRIDGE_AUTH_TOKEN}
ENV PORT=${PORT}
ENV BRIDGE_IDENTITY=${BRIDGE_IDENTITY}
ENV BRIDGE_PSK=${BRIDGE_PSK}
ENV BRIDGE_TOTAL_MACHINES=${BRIDGE_TOTAL_MACHINES}
ENV SHARD_PER_CLUSTER=${SHARD_PER_CLUSTER}

WORKDIR /usr/tohru/bridge

COPY package*.json .

RUN ["npm", "install"]

COPY . .

RUN ["npm", "run", "build"]

EXPOSE ${PORT}

CMD ["npm", "run", "start:bridge"]